// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// ENUMS
// ==========================================

enum Role {
  EO
  User
}

// ==========================================
// USER & AUTHENTICATION
// ==========================================

model User {
  id                String  @id @default(uuid()) @db.Uuid
  email             String  @unique @db.VarChar(255)
  password          String  @db.VarChar(255)
  username          String  @db.VarChar(100)
  fullName          String  @map("full_name") @db.VarChar(255)
  phoneNumber       String  @map("phone_number") @db.VarChar(20)
  profilePictureUrl String? @map("profile_picture_url") @db.Text
  role              Role    
  referralCode      String  @unique @map("referral_code") @db.VarChar(6)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  organizer           Organizer?
  passwordResetTokens PasswordResetToken[]
  referralsAsReferrer Referral[]           @relation("ReferrerRelation")
  referralAsReferee   Referral?            @relation("RefereeRelation")
  userPoints          UserPoint[]
  userCoupons         UserCoupon[]
  eventVoucherUsages  EventVoucherUsage[]
  transactions        Transaction[]
  eventReviews        EventReview[]

  @@map("users")
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(100)
  expiredAt DateTime @map("expired_at")
  isUsed    Boolean  @default(false) @map("is_used")

  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model Organizer {
  id             String  @id @default(uuid()) @db.Uuid
  userId         String  @unique @map("user_id") @db.Uuid
  organizerName  String  @map("organizer_name") @db.VarChar(255)
  companyAddress String @map("company_address") @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  events Event[]

  @@map("organizers")
}

// ==========================================
// REFERRAL SYSTEM
// ==========================================

model Referral {
  id         String @id @default(uuid()) @db.Uuid
  referrerId String @map("referrer_id") @db.Uuid
  refereeId  String @unique @map("referee_id") @db.Uuid
  codeUsed   String @map("code_used") @db.VarChar(6)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  referrer    User         @relation("ReferrerRelation", fields: [referrerId], references: [id], onDelete: Cascade)
  referee     User         @relation("RefereeRelation", fields: [refereeId], references: [id], onDelete: Cascade)
  userPoints  UserPoint[]
  userCoupons UserCoupon[]

  @@map("referrals")
}

model UserPoint {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  amount     Int      @default(10000)
  source     String   @db.VarChar(50)
  referralId String?  @map("referral_id") @db.Uuid
  expiredAt  DateTime @map("expired_at")
  isUsed     Boolean  @default(false) @map("is_used")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  referral    Referral?    @relation(fields: [referralId], references: [id], onDelete: SetNull)
  pointUsages PointUsage[]

  @@map("user_points")
}

model UserCoupon {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  couponCode    String    @unique @map("coupon_code") @db.VarChar(20)
  discountType  String    @map("discount_type") @db.VarChar(20)
  discountValue Int       @map("discount_value")
  isUsed        Boolean   @default(false) @map("is_used")
  usedAt        DateTime? @map("used_at")
  referralId    String?   @map("referral_id") @db.Uuid
  expiredAt     DateTime  @map("expired_at")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  referral     Referral?     @relation(fields: [referralId], references: [id], onDelete: SetNull)
  transactions Transaction[]

  @@map("user_coupons")
}

// ==========================================
// EVENT VOUCHERS
// ==========================================

model EventVoucher {
  id            String   @id @default(uuid()) @db.Uuid
  eventId       String   @map("event_id") @db.Uuid
  voucherCode   String   @unique @map("voucher_code") @db.VarChar(20)
  voucherName   String   @map("voucher_name") @db.VarChar(255)
  discountType  String   @map("discount_type") @db.VarChar(20)
  discountValue Int      @map("discount_value")
  maxUsage      Int      @map("max_usage")
  usedCount     Int      @default(0) @map("used_count")
  maxDiscount   Int?     @map("max_discount")
  startDate     DateTime @map("start_date")
  expiredAt     DateTime @map("expired_at")
  isActive      Boolean  @default(true) @map("is_active")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  event              Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventVoucherUsages EventVoucherUsage[]
  transactions       Transaction[]

  @@map("event_vouchers")
}

model EventVoucherUsage {
  id              String @id @default(uuid()) @db.Uuid
  voucherId       String @map("voucher_id") @db.Uuid
  userId          String @map("user_id") @db.Uuid
  transactionId   String @map("transaction_id") @db.Uuid
  discountApplied Int    @map("discount_applied")

  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  voucher     EventVoucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction Transaction  @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("event_voucher_usages")
}

// ==========================================
// EVENTS
// ==========================================

model Event {
  id           String    @id @default(uuid()) @db.Uuid
  organizerId  String    @map("organizer_id") @db.Uuid
  name         String    @db.VarChar(255)
  slug         String    @unique @db.VarChar(255)
  categoryId   String    @map("category_id") @db.Uuid
  eventDate    DateTime  @map("event_date") @db.Date
  eventTime    DateTime  @map("event_time") @db.Time()
  endDate      DateTime? @map("end_date") @db.Date
  endTime      DateTime? @map("end_time") @db.Time()
  cityId       String    @map("city_id") @db.Uuid
  venueName    String    @map("venue_name") @db.VarChar(255)
  venueAddress String    @map("venue_address") @db.Text
  description  String    @db.Text
  status       String    @default("draft") @db.VarChar(20)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  organizer     Organizer      @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  category      EventCategory  @relation(fields: [categoryId], references: [id])
  city          City           @relation(fields: [cityId], references: [id])
  eventImages   EventImage[]
  ticketTypes   TicketType[]
  eventVouchers EventVoucher[]
  eventReviews  EventReview[]
  transactions  Transaction[]

  @@map("events")
}

model EventImage {
  id       String @id @default(uuid()) @db.Uuid
  eventId  String @map("event_id") @db.Uuid
  imageUrl String @map("image_url") @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_images")
}

model EventCategory {
  id   String @id @default(uuid()) @db.Uuid
  name String @db.VarChar(100)
  slug String @unique @db.VarChar(100)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  events Event[]

  @@map("event_categories")
}

model TicketType {
  id          String  @id @default(uuid()) @db.Uuid
  eventId     String  @map("event_id") @db.Uuid
  name        String  @db.VarChar(100)
  description String? @db.Text
  price       Int     @default(0)
  quota       Int
  soldCount   Int     @default(0) @map("sold_count")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  event            Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  transactionItems TransactionItem[]

  @@map("ticket_types")
}

model EventReview {
  id         String  @id @default(uuid()) @db.Uuid
  eventId    String  @map("event_id") @db.Uuid
  userId     String  @map("user_id") @db.Uuid
  rating     Decimal @db.Decimal(2, 1)
  reviewText String? @map("review_text") @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_reviews")
}

// ==========================================
// LOCATION
// ==========================================

model Province {
  id   String @id @default(uuid()) @db.Uuid
  name String @db.VarChar(100)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  cities City[]

  @@map("provinces")
}

model City {
  id         String @id @default(uuid()) @db.Uuid
  provinceId String @map("province_id") @db.Uuid
  name       String @db.VarChar(100)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  province Province @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  events   Event[]

  @@map("cities")
}

// ==========================================
// TRANSACTIONS
// ==========================================

model Transaction {
  id              String  @id @default(uuid()) @db.Uuid
  userId          String  @map("user_id") @db.Uuid
  eventId         String  @map("event_id") @db.Uuid
  invoiceNumber   String  @unique @map("invoice_number") @db.VarChar(50)
  subtotal        Int
  pointsUsed      Int     @default(0) @map("points_used")
  couponDiscount  Int     @default(0) @map("coupon_discount")
  voucherDiscount Int     @default(0) @map("voucher_discount")
  totalAmount     Int     @map("total_amount")
  paymentStatus   String  @default("waiting_for_payment") @map("payment_status") @db.VarChar(20)
  paymentProofUrl String? @map("payment_proof_url") @db.Text

  proofUploadedAt      DateTime? @map("proof_uploaded_at")
  confirmedAt          DateTime? @map("confirmed_at")
  paymentDeadline      DateTime  @map("payment_deadline")
  confirmationDeadline DateTime? @map("confirmation_deadline")

  userCouponId   String? @map("user_coupon_id") @db.Uuid
  eventVoucherId String? @map("event_voucher_id") @db.Uuid

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  event              Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userCoupon         UserCoupon?         @relation(fields: [userCouponId], references: [id], onDelete: SetNull)
  eventVoucher       EventVoucher?       @relation(fields: [eventVoucherId], references: [id], onDelete: SetNull)
  transactionItems   TransactionItem[]
  eventVoucherUsages EventVoucherUsage[]
  pointUsages        PointUsage[]

  @@map("transactions")
}

model TransactionItem {
  id            String @id @default(uuid()) @db.Uuid
  transactionId String @map("transaction_id") @db.Uuid
  ticketTypeId  String @map("ticket_type_id") @db.Uuid
  quantity      Int
  unitPrice     Int    @map("unit_price")
  subtotal      Int

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  ticketType  TicketType  @relation(fields: [ticketTypeId], references: [id])
  tickets     Ticket[]

  @@map("transaction_items")
}

model Ticket {
  id                String    @id @default(uuid()) @db.Uuid
  transactionItemId String    @map("transaction_item_id") @db.Uuid
  ticketCode        String    @unique @map("ticket_code") @db.VarChar(20)
  attendeeName      String?   @map("attendee_name") @db.VarChar(255)
  attendeeEmail     String?   @map("attendee_email") @db.VarChar(255)
  isCheckedIn       Boolean   @default(false) @map("is_checked_in")
  checkedInAt       DateTime? @map("checked_in_at")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  transactionItem TransactionItem @relation(fields: [transactionItemId], references: [id], onDelete: Cascade)

  @@map("tickets")
}

model PointUsage {
  id            String @id @default(uuid()) @db.Uuid
  userPointId   String @map("user_point_id") @db.Uuid
  transactionId String @map("transaction_id") @db.Uuid
  amountUsed    Int    @map("amount_used")

  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  userPoint   UserPoint   @relation(fields: [userPointId], references: [id], onDelete: Cascade)
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("point_usages")
}
